apiVersion: apps/v1
kind: Deployment
metadata:
  name: sdf-docs-deployment
  labels:
    app: nginx-sdf-docs
    facility: scs
    space: sdf
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-sdf-docs
      facility: scs
      space: sdf
  template:
    metadata:
      labels:
        app: nginx-sdf-docs
        facility: scs
        space: sdf
    spec:
      volumes:
        - name: content
          emptyDir: {}
        - name: nginx-configmap-volume
          configMap:
            name: nginx-configmap
            items:
            - key: default.conf
              path: default.conf
            - key: mime.types
              path: mime.types
            - key: nginx.conf
              path: nginx.conf
      containers:
        # --- Note: see git-sync demo at https://github.com/kubernetes/git-sync/blob/master/demo/deployment.yaml#L18
        # This container pulls a git repo into the "content" volume.  If this
        # were a "real" app it would probably have livenessProbe and resources,
        # and maybe a secret to get credentials for your git server.
        - name: git-sync
          image: registry.k8s.io/git-sync/git-sync:v4.2.3
          args:
            - --repo=https://github.com/slaclab/sdf-docs
            - --ref=s3df
            - --root=/git
            - --period=60s
            - --link=head
            - --max-failures=1000000000
            - -v=2
          volumeMounts:
            - name: content
              mountPath: /git
        - name: nginx
          image: nginx:1.14.2
          ports:
          - containerPort: 80
          volumeMounts:
            - name: content
              mountPath: /git
              readOnly: true
            - name: nginx-configmap-volume
              mountPath: /etc/nginx/conf.d/default.conf
              subPath: default.conf
